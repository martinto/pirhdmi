#!/usr/bin/env python3

import os
import subprocess
import threading
from gpiozero import MotionSensor
from signal import pause
pir = MotionSensor(4)
KMSPRINT='/usr/bin/kmsprint'
XRANDR='/usr/bin/xrandr'
ON_TIME=120.0

def is_off():
    status = subprocess.check_output([KMSPRINT, "-p"]).decode("utf-8")
    if "    DPMS (2) = 0 (On) [On=0|Standby=1|Suspend=2|Off=3]" in status:
        return False
    else:
        return True

def hdmi_off():
    subprocess.run([XRANDR, '--output', 'HDMI-1', '--off'], env=dict(os.environ, DISPLAY=":0"))

def start_off_timer():
    global timer
    timer = threading.Timer(ON_TIME, lambda: hdmi_off())
    timer.start()

def restart_off_timer():
    global timer
    timer.cancel()
    start_off_timer()

def hdmi_on():
    if is_off():
        subprocess.run([XRANDR, '--output', 'HDMI-1', '--auto', '--rotate', 'left'], env=dict(os.environ, DISPLAY=":0"))
        start_off_timer()
    else:
        restart_off_timer()

pir.when_motion = lambda : hdmi_on()

hdmi_off()
pause()
